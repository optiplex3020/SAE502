<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuthCorp - Tableau de bord</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/keycloak-js"></script>
    <script src="js/keycloak.js" defer></script> <!-- üî• Ajout de `defer` -->
</head>
<body>
    <header>
        <h1>Bienvenue sur votre espace s√©curis√©</h1>
    </header>
    
    <main>
        <p id="roleMessage"></p>

        <h2>Informations de l'utilisateur</h2>
        <p>Nom d'utilisateur : <span id="username">Chargement...</span></p>
        <p>Email : <span id="email">Chargement...</span></p>
        <p>R√¥les : <span id="roles">Chargement...</span></p>

        <h3>Votre Token JWT :</h3>
        <textarea id="jwtToken" rows="5" cols="50" readonly></textarea>
        <button onclick="copyToken()">Copier</button>

        <h2>üîí Informations prot√©g√©es</h2>
        <button onclick="getProtectedData()">R√©cup√©rer les donn√©es</button>
        <pre id="apiResponse"></pre>

        <a href="/backend/logout.php" class="btn">D√©connexion</a>
    </main>

    <script>
        // Initialisation de Keycloak
        keycloak.init({ onLoad: 'login-required' }).then(authenticated => {
            if (authenticated) {
                console.log("Keycloak token complet :", keycloak);
                console.log("Token d√©cod√© :", keycloak.tokenParsed);

                // V√©rifier si `keycloak.tokenParsed` existe avant d'acc√©der aux donn√©es
                if (keycloak.tokenParsed) {
                    // Afficher les informations de l'utilisateur
                    document.getElementById("username").innerText = keycloak.tokenParsed.preferred_username || "Non disponible";
                    document.getElementById("email").innerText = keycloak.tokenParsed.email || "Non disponible";
                    document.getElementById("roles").innerText = keycloak.tokenParsed.realm_access?.roles.join(", ") || "Aucun r√¥le";

                    // Afficher le Token JWT
                    document.getElementById("jwtToken").value = keycloak.token;

                    // Gestion des r√¥les
                    const roles = keycloak.tokenParsed.realm_access?.roles || [];
                    if (roles.includes("admin")) {
                        document.getElementById("roleMessage").innerText = "Bienvenue, Administrateur !";
                    } else {
                        document.getElementById("roleMessage").innerText = "Bienvenue, Utilisateur standard.";
                    }
                } else {
                    console.error("Probl√®me : Token vide !");
                }
            } else {
                keycloak.login();
            }
        }).catch(error => {
            console.error("Erreur Keycloak :", error);
        });

    document.addEventListener("DOMContentLoaded", function () {
        if (typeof keycloak === "undefined") {
            console.error("Erreur : Keycloak n'est pas initialis√© !");
            return;
        }

        keycloak.init({ onLoad: 'login-required' }).then(authenticated => {
            if (authenticated) {
                console.log("Keycloak Object :", keycloak);
                console.log("Token :", keycloak.token);
                console.log("Token d√©cod√© :", keycloak.tokenParsed);

                if (keycloak.tokenParsed) {
                    document.getElementById("username").innerText = keycloak.tokenParsed.preferred_username || "Non disponible";
                    document.getElementById("email").innerText = keycloak.tokenParsed.email || "Non disponible";
                    document.getElementById("roles").innerText = keycloak.tokenParsed.realm_access?.roles.join(", ") || "Aucun r√¥le";
                    document.getElementById("jwtToken").value = keycloak.token;
                } else {
                    console.error("Erreur : Token Keycloak vide !");
                }
            } else {
                keycloak.login();
            }
        }).catch(error => {
            console.error("Erreur Keycloak :", error);
        });
    });


        // Fonction pour copier le Token JWT
        function copyToken() {
            navigator.clipboard.writeText(keycloak.token);
            alert("Token copi√© !");
        }

        // Fonction pour r√©cup√©rer des donn√©es prot√©g√©es depuis l'API
        function getProtectedData() {
            fetch("/backend/api/protected.php", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + keycloak.token
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("apiResponse").textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => console.error("Erreur API :", error));
        }
    </script>
</body>
</html>